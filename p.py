from database import remove_approved_user, ApprovedUser, get_approved_users, add_approved_user, is_approved_user, get_whisper, store_whisper #type: ignore
from telethon import TelegramClient, events, Button
import requests, os, operator, asyncio, random, uuid
api_id = os.getenv('API_ID')      
api_hash = os.getenv('API_HASH')  
bot_token = os.getenv('BOT_TOKEN') 
ABH = TelegramClient('code', api_id, api_hash).start(bot_token=bot_token)
@ABH.on(events.InlineQuery)
async def inline_query_handler(event):
    ifid = await event.get_reply_message()
    if ifid:
        to_id = ifid.sender_id
    builder = event.builder
    query = event.text
    sender = event.sender_id
    if query.strip():
        parts = query.split(' ')
        if len(parts) >= 2:
            message = ' '.join(parts[:-1])
            username = parts[-1]
            if not username.startswith('@'):
                username = f'@{username}'
            try:
                reciver = await ABH.get_entity(username)
                reciver_id = reciver.id
                whisper_id = str(uuid.uuid4())
                if not username and ifid:
                    reciver_id = to_id
                    whisper_id = str(uuid.uuid4())
                store_whisper(whisper_id, sender, reciver_id, username, message)
                result = builder.article(
                    title='Ø§Ø¶ØºØ· Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ù…Ø³Ø©',
                    description=f'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {username}',
                    text="Ù‡Ù…Ø³Ø© Ø³Ø±ÙŠØ© Ø¥Ù„Ù‰ \n Ø§Ù„Ù„Ù‡ ÙŠØ«Ø®Ù† Ø§Ù„Ù„Ø¨Ù† Ø¹Ù…ÙŠ ğŸ˜Œ ({username})",
                    buttons=[
                        Button.inline(
                            text='ğŸ«µğŸ¾ Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ù…Ø³Ø©', 
                            data=f'send:{whisper_id}'
                        )                    ]                )
            except Exception as e:
                result = builder.article(
                    title='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
                    description="Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.",
                )
        else:
            return
        await event.answer([result])
@ABH.on(events.CallbackQuery)
async def callback_query_handler(event):
    data = event.data.decode('utf-8')
    if data.startswith('send:'):
        whisper_id = data.split(':')[1]
        whisper = get_whisper(whisper_id)
        if whisper:
            if event.sender_id == whisper.sender_id or event.sender_id == whisper.reciver_id:
                await event.answer(f"{whisper.message}", alert=True)
            else:
                await event.answer("Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø­Ø´Ø±ÙŠØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ù…Ø³Ø© Ù„ÙŠØ³Øª Ù…ÙˆØ¬Ù‡Ø© Ø¥Ù„ÙŠÙƒ!", alert=True)
                
ABH.run_until_disconnected() 
