from telethon import TelegramClient, events
from db import add_approved_user, remove_approved_user, get_approved_users, create_table
import os

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
api_id = os.getenv('API_ID')
api_hash = os.getenv('API_HASH')
bot_token = os.getenv('BOT_TOKEN')

# ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
if not api_id or not api_hash or not bot_token:
    raise ValueError("ØªØ£ÙƒØ¯ Ù…Ù† Ø¶Ø¨Ø· API_ID Ùˆ API_HASH Ùˆ BOT_TOKEN ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©.")

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
ABH = TelegramClient('c', api_id, api_hash).start(bot_token=bot_token)

# Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
create_table()

@ABH.on(events.NewMessage(pattern='Ø³Ù…Ø§Ø­'))
async def approve_user(event):
    if event.is_group:
        if event.is_reply:
            reply_message = await event.get_reply_message()
            user_id = reply_message.sender_id
            add_approved_user(user_id)  # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… user_id ÙÙ‚Ø·
            await event.reply(f"âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ ID: {user_id} Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.")
        else:
            await event.reply("â— ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù‡ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.")
    else:
        return

@ABH.on(events.NewMessage(pattern='Ø±ÙØ¶'))
async def disapprove_user(event):
    if event.is_group:
        if event.is_reply:
            reply_message = await event.get_reply_message()
            user_id = reply_message.sender_id
            remove_approved_user(user_id)  # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… user_id ÙÙ‚Ø·
            await event.reply(f"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ ID: {user_id} Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.")
        else:
            await event.reply("â— ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù‡ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.")
    else:
        return

@ABH.on(events.NewMessage(pattern='Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù…'))
async def list_approved_users(event):
    if event.is_group:
        approved_users = get_approved_users()
        if approved_users:
            approved_list = "\n".join([str(user_id) for user_id in approved_users])
            await event.reply(f"ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:\n{approved_list}")
        else:
            await event.reply("â— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.")
    else:
        return

@ABH.on(events.MessageEdited)
async def echo(event):
    if event.is_group:
        user_id = event.sender_id
        approved_users = get_approved_users()

        if user_id in approved_users:  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            return
        else:
            await event.reply("Ù‡Ù†Ø§Ù„Ùƒ Ø´Ø®Øµ Ø¹Ø¯Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø§Ù„Ù…Ù‚ØµØ¯ ğŸ¤”")
    else:
        return

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡
ABH.run_until_disconnected()
