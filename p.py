from telethon import TelegramClient, events
import os, yt_dlp

# Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
api_id = os.getenv('API_ID')      
api_hash = os.getenv('API_HASH')  
bot_token = os.getenv('BOT_TOKEN') 

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
ABH = TelegramClient('code', api_id, api_hash).start(bot_token=bot_token)

@ABH.on(events.NewMessage(pattern=r'ÙŠÙˆØª (.+)'))  
async def youtube_download(event):
    search_query = event.pattern_match.group(1)  # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    await event.reply(f"ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {search_query}")

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† ÙƒÙˆÙƒÙŠØ²
    ydl_opts = {
        'format': 'bestaudio/best',  # ØªØ­Ù…ÙŠÙ„ Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© Ù„Ù„ØµÙˆØª ÙÙ‚Ø·
        'postprocessors': [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '192',
        }],
        'outtmpl': 'downloaded_audio.%(ext)s',  # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¨Ø§Ø³Ù… Ø«Ø§Ø¨Øª
        'noplaylist': True,  # ØªØ¹Ø·ÙŠÙ„ ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ´ØºÙŠÙ„
        'extractor-args': {'youtube': {'player_client': ['web']}},  # ÙØ±Ø¶ Ù…Ø´ØºÙ„ Ø§Ù„ÙˆÙŠØ¨ Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        'http_headers': {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        }  # ØªØºÙŠÙŠØ± Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø®Ø¯Ø§Ø¹ ÙŠÙˆØªÙŠÙˆØ¨
    }

    try:
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            ydl.download([f"ytsearch1:{search_query}"])  # ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© ÙÙ‚Ø·
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        audio_file = "downloaded_audio.mp3"
        if os.path.exists(audio_file):
            await event.reply("âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...")
            await ABH.send_file(event.chat_id, audio_file, caption=f"ğŸµ {search_query}")
            os.remove(audio_file)  # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        else:
            await event.reply("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù!")

    except Exception as e:
        await event.reply(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
print("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
ABH.run_until_disconnected()
