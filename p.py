from telethon import TelegramClient, events
import os
import json

# Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª
api_id = int(os.getenv('API_ID'))
api_hash = os.getenv('API_HASH')
bot_token = os.getenv('BOT_TOKEN')

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
ABH = TelegramClient("bot_session", api_id, api_hash).start(bot_token=bot_token)

# Ù…Ù„Ù Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
GROUPS_FILE = "groups.json"

# ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
def load_groups():
    if os.path.exists(GROUPS_FILE):
        with open(GROUPS_FILE, "r") as f:
            return set(json.load(f))
    return set()

# Ø­ÙØ¸ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
def save_groups():
    with open(GROUPS_FILE, "w") as f:
        json.dump(list(group_ids), f)

# Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
group_ids = load_groups()

# ğŸ› ï¸ **ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠ Ø§Ù„Ø¨ÙˆØª ÙÙŠÙ‡Ø§ Ù…Ø´Ø±Ù Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø©**
@ABH.on(events.NewMessage)
async def update_groups(event):
    global group_ids

    chat = await event.get_chat()
    if chat.id not in group_ids:  # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©
        try:
            permissions = await ABH.get_permissions(chat, 'me')  # Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª
            if permissions.is_admin:  # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨ÙˆØª Ù…Ø´Ø±ÙÙ‹Ø§
                group_ids.add(chat.id)
                save_groups()
                print(f"âœ… Ø§Ù„Ø¨ÙˆØª Ù…Ø´Ø±Ù ÙÙŠ: {chat.title} - {chat.id}")
        except Exception as e:
            print(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† {chat.title}: {e}")

# ğŸ“¢ **Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¨ÙˆØª Ù…Ø´Ø±Ù**
@ABH.on(events.NewMessage(pattern="/alert"))
async def send_alert(event):
    message_text = None

    if event.reply_to_msg_id:
        replied_msg = await event.get_reply_message()
        message_text = replied_msg.text
    else:
        command_parts = event.raw_text.split(maxsplit=1)
        if len(command_parts) > 1:
            message_text = command_parts[1]

    if not message_text:
        await event.reply("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø¨Ø¹Ø¯ `/alert`.")
        return

    await event.reply(f"ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ {len(group_ids)} Ù…Ø¬Ù…ÙˆØ¹Ø©...")

    for group_id in group_ids:
        try:
            await ABH.send_message(group_id, f"ğŸ“¢ **ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…:**\n{message_text}")
            print(f"âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰: {group_id}")
        except Exception as e:
            print(f"âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ {group_id}: {e}")

    await event.reply("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª!")

print("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
ABH.run_until_disconnected()
